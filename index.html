<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Анимация Весна — Сердечки и цветы</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    width: 100%; height: 100vh; min-height: 100vh;
    overflow: auto;
    background: #FFFFFF;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    display: flex; align-items: center; justify-content: center;
  }

  /* ===== Device Frame ===== */
  .device-frame {
    width: 375px; height: 812px;
    position: relative;
    overflow: hidden;
    border-radius: 40px;
    box-shadow: 0 8px 40px rgba(0,0,0,0.15);
    flex-shrink: 0;
    container-type: inline-size;
  }

  .device-frame canvas {
    display: block;
    position: absolute; inset: 0;
    width: 100%; height: 100%;
  }

  /* ===== Stage (centers frame, anchors side panel) ===== */
  .stage {
    position: relative;
    flex-shrink: 0;
  }

  /* ===== Side Settings Panel ===== */
  .side-panel {
    position: absolute;
    top: 50%; left: calc(100% + 40px);
    width: 260px;
    background: #2C2C2E;
    border-radius: 16px;
    padding: 20px;
    color: #fff;
    font-size: 13px;
    opacity: 0; visibility: hidden;
    transform: translateY(-50%) translateX(-12px);
    transition: opacity 0.25s, visibility 0.25s, transform 0.25s;
    max-height: 100%;
    overflow-y: auto;
  }
  .side-panel.open {
    opacity: 1; visibility: visible;
    transform: translateY(-50%) translateX(0);
  }

  .sp-title {
    font-size: 15px; font-weight: 700;
    margin-bottom: 16px; text-align: center;
  }
  .sp-divider {
    height: 1px; background: rgba(255,255,255,0.1);
    margin: 20px 0;
  }


  /* ===== GAME UI ===== */
  .game-ui {
    display: flex;
    position: absolute; inset: 0;
    z-index: 200;
    flex-direction: column;
  }

  /* -- navbar -- */
  .game-header {
    width: 100%; height: 32px;
    padding: 0 16px;
    display: flex; align-items: center;
    gap: 12px;
    pointer-events: auto;
    flex-shrink: 0;
    margin-top: 26px;
  }

  /* -- logo -- */
  .logo {
    display: flex; gap: 1px;
    height: 27px; flex-shrink: 0;
  }
  .logo-card {
    height: 27px;
    perspective: 600px;
  }
  .logo-card-inner {
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.8s cubic-bezier(0.4, 0.2, 0.2, 1);
  }
  .logo-card-inner.flipped { transform: rotateY(180deg); }
  .logo-card-front { height: 100%; }
  .logo-card-back {
    position: absolute; top: 0; left: 0; height: 100%;
    transform: rotateY(180deg);
  }
  .logo-card-front,
  .logo-card-back { backface-visibility: hidden; }
  .logo-card img { height: 100%; width: auto; display: block; }

  /* -- header icons -- */
  .header-icons {
    display: flex; align-items: center; gap: 20px;
    margin-left: auto;
  }
  .h-icon {
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    background: none; border: none;
    padding: 0; cursor: pointer;
  }
  .h-icon svg { width: 24px; height: 24px; }

  /* -- energy badge -- */
  .energy-badge {
    height: 32px;
    display: flex; align-items: center; gap: 4px;
    padding: 0 10px 0 8px;
    margin-left: 14px;
    background: #2C2C2E;
    border-radius: 16px;
    border: none; cursor: pointer;
    color: #fff;
  }
  .energy-badge svg {
    width: 14px; height: 16px;
    flex-shrink: 0;
  }
  .energy-badge span {
    font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
    font-style: normal;
    font-weight: 600;
    font-size: 17px;
    line-height: 20px;
    text-align: center;
    letter-spacing: -0.41px;
    color: #FFFFFF;
    flex: none;
  }

  /* -- grid -- */
  .grid-wrapper {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    margin-top: 32px;
    margin-bottom: 40px;
    padding: 0 16px;
    pointer-events: auto;
    min-height: 0;
    overflow: hidden;
  }
  .grid {
    display: grid;
    grid-template-rows: repeat(6, var(--cell));
    grid-template-columns: repeat(5, var(--cell));
    column-gap: 6px;
    row-gap: 8px;
  }
  .cell {
    perspective: 800px;
    font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif;
    font-style: normal;
    font-weight: 300;
    font-size: 28px;
    color: #fff;
    text-transform: uppercase;
    user-select: none;
  }
  .cell.filled .cell-front {
    animation: pop 0.1s ease;
  }
  @keyframes pop {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.12); }
    100% { transform: scale(1); }
  }
  .cell-inner {
    width: 100%; height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.8s cubic-bezier(0.4, 0, 0.15, 1);
  }
  .cell-inner.flipped {
    transform: rotateY(180deg);
  }
  .cell-front,
  .cell-back {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    border-radius: 6px;
  }
  .cell-front {
    background: #202020;
    border: 1px solid #FFDD2D;
  }
  .cell-back {
    transform: rotateY(180deg);
    border: 1px solid transparent;
  }
  .cell-back.absent  { background: #4E4E4E; border-color: #4E4E4E; color: #fff; }
  .cell-back.present { background: #FFFFFF; border-color: #FFFFFF; color: #1C1C1E; font-weight: 400; }
  .cell-back.correct { background: #FFDD2D; border-color: #FFDD2D; color: #1C1C1E; font-weight: 400; }

  /* -- keyboard -- */
  .keyboard {
    width: 100%;
    padding: 0 16px 14px;
    display: flex; flex-direction: column;
    gap: 8px;
    align-items: center;
    pointer-events: auto;
    flex-shrink: 0;
  }
  .kb-row {
    display: flex; gap: 3px;
    width: 100%;
  }
  .kb-row:nth-child(2) {
    padding: 0 var(--kb-mid-pad, 0px);
  }
  .key {
    height: 46px; min-width: 0;
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 6px;
    background: #202020;
    color: #fff;
    font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 16px; font-weight: 400;
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s, color 0.15s, transform 0.08s;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    text-transform: uppercase;
  }
  .key:active { transform: scale(0.92); }
  .key.wide {
    flex: 1.5;
    background: #3A3A3C;
    border-color: #3A3A3C;
  }
  .key.wide svg { width: 24px; height: 24px; }
  .key.correct {
    background: #FFDD2D; border-color: #FFDD2D;
    color: #1C1C1E;
  }
  .key.present {
    background: #FFFFFF; border-color: #FFFFFF;
    color: #1C1C1E;
  }
  .key.absent {
    background: #4E4E4E; border-color: #4E4E4E;
    color: #fff;
  }

  /* -- settings side-panel shared styles -- */
  .s-presets {
    display: flex; gap: 6px; margin-bottom: 16px;
  }
  .s-preset {
    flex: 1; height: 30px;
    border: 1.5px solid rgba(255,255,255,0.15);
    border-radius: 8px; background: transparent;
    color: rgba(255,255,255,0.7);
    font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
    font-family: inherit;
  }
  .s-preset:hover { background: rgba(255,255,255,0.06); }
  .s-preset.active {
    background: #F2D049; color: #1C1C1E;
    border-color: #F2D049;
  }

  .s-group { margin-bottom: 14px; }
  .s-group:last-child { margin-bottom: 0; }
  .s-label {
    display: flex; justify-content: space-between;
    margin-bottom: 5px; font-size: 12px;
    color: rgba(255,255,255,0.6); font-weight: 500;
  }
  .s-val {
    color: #F2D049; font-weight: 700;
    background: transparent; border: 1px solid transparent;
    border-radius: 4px;
    width: 48px; text-align: right;
    font-family: inherit; font-size: 12px;
    padding: 2px 4px;
    outline: none;
    -moz-appearance: textfield;
    transition: border-color 0.2s, background 0.2s;
  }
  .s-val::-webkit-inner-spin-button,
  .s-val::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  .s-val:hover { border-color: rgba(242,208,73,0.3); }
  .s-val:focus {
    border-color: #F2D049;
    background: rgba(242,208,73,0.08);
  }

  .side-panel input[type="range"] {
    width: 100%; height: 4px; border-radius: 2px;
    background: rgba(255,255,255,0.12);
    -webkit-appearance: none; appearance: none; outline: none;
  }
  .side-panel input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 16px; height: 16px;
    border-radius: 50%; background: #F2D049; cursor: pointer;
    box-shadow: 0 0 6px rgba(242,208,73,0.4);
  }
  .side-panel input[type="range"]::-moz-range-thumb {
    width: 16px; height: 16px; border-radius: 50%;
    background: #F2D049; cursor: pointer; border: none;
  }

  /* -- system app bar -- */
  .system-bar {
    width: 100%; height: 104px;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    background: #1C1C1E;
  }
  .sb-statusbar {
    height: 44px;
    background: #000;
  }
  .sb-notch-area {
    position: absolute;
    top: 44px; left: 0; right: 0; bottom: 0;
    background: #000;
    overflow: hidden;
  }
  .sb-app-bg {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #1C1C1E;
    border-radius: 14px 14px 0 0;
  }

  /* -- home indicator -- */
  .home-indicator {
    width: 100%; height: 34px;
    flex-shrink: 0;
    position: relative;
  }
  .home-bar {
    position: absolute;
    top: 21px; left: 50%;
    transform: translateX(-50%);
    width: 133px; height: 5px;
    background: #fff;
    border-radius: 2.5px;
  }

  /* -- responsive via container query -- */
  @container (max-width: 359px) {
    .system-bar { height: 90px; }
    .home-indicator { display: none; }
  }

  .toast {
    position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
    background: #fff; color: #1C1C1E;
    padding: 12px 24px; border-radius: 8px;
    font-size: 14px; font-weight: 700; z-index: 300;
    opacity: 0; transition: opacity 0.25s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="stage">
<div class="device-frame" id="deviceFrame">
<canvas id="canvas"></canvas>

<div class="game-ui" id="gameUI">

  <div class="system-bar">
    <div class="sb-statusbar"></div>
    <div class="sb-notch-area">
      <div class="sb-app-bg"></div>
    </div>
  </div>

  <div class="game-header">
    <div class="logo" id="logo">
      <div class="logo-card"><div class="logo-card-inner">
        <div class="logo-card-front"><img src="img/v2.png" alt="В"></div>
        <div class="logo-card-back"><img src="img/5.png" alt="5"></div>
      </div></div>
      <div class="logo-card"><div class="logo-card-inner">
        <div class="logo-card-front"><img src="img/e.png" alt="Е"></div>
        <div class="logo-card-back"><img src="img/b.png" alt="Б"></div>
      </div></div>
      <div class="logo-card"><div class="logo-card-inner">
        <div class="logo-card-front"><img src="img/s.png" alt="С"></div>
        <div class="logo-card-back"><img src="img/u.png" alt="У"></div>
      </div></div>
      <div class="logo-card"><div class="logo-card-inner">
        <div class="logo-card-front"><img src="img/n.png" alt="Н"></div>
        <div class="logo-card-back"><img src="img/k.png" alt="К"></div>
      </div></div>
      <div class="logo-card"><div class="logo-card-inner">
        <div class="logo-card-front"><img src="img/a.png" alt="А"></div>
        <div class="logo-card-back"><img src="img/v1.png" alt="В"></div>
      </div></div>
    </div>
    <div class="header-icons">
      <button class="energy-badge">
        <svg viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.70941 7.50035e-06C5.63554 -0.000203071 5.56291 0.0211529 5.49876 0.061946C5.4346 0.102739 5.38118 0.161544 5.34381 0.232497L1.05802 8.29706C1.02034 8.36863 1.00033 8.45002 1 8.53297C0.99968 8.61593 1.01906 8.69751 1.05618 8.76944C1.0933 8.84137 1.14683 8.90109 1.21136 8.94256C1.27589 8.98403 1.34912 9.00576 1.42363 9.00556H4.62662L3.15428 15.4105C3.13081 15.5106 3.13759 15.6164 3.17355 15.7117C3.20952 15.807 3.27267 15.8865 3.35326 15.9379C3.43385 15.9892 3.52738 16.0096 3.61941 15.9958C3.71143 15.9821 3.79683 15.9349 3.86239 15.8617L12.8772 5.84534C12.936 5.77943 12.976 5.6956 12.9921 5.60442C13.0082 5.51324 12.9997 5.4188 12.9676 5.333C12.9356 5.24719 12.8814 5.17387 12.812 5.12229C12.7426 5.0707 12.661 5.04315 12.5776 5.04311H8.48242L10.8898 0.718612C10.9296 0.647159 10.9515 0.565133 10.9532 0.481066C10.9549 0.396999 10.9363 0.313964 10.8994 0.240601C10.8625 0.167237 10.8086 0.106225 10.7434 0.0639121C10.6781 0.0215996 10.6039 -0.000467205 10.5283 7.50035e-06H5.70941Z" fill="white"/></svg>
        <span>17</span>
      </button>
      <button class="h-icon" id="btnToggleGrid">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="mGrid" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24"><path opacity="0.95" d="M2.5 7.65789C2.5 5.91384 3.91777 4.5 5.66667 4.5H10.8125V7.65789C10.8125 9.40195 9.39474 10.8158 7.64583 10.8158H2.5V7.65789Z" fill="black"/><path opacity="0.6" d="M2.5 16.3421C2.5 14.598 3.91777 13.1842 5.66667 13.1842H10.8125V16.3421C10.8125 18.0862 9.39474 19.5 7.64583 19.5H2.5V16.3421Z" fill="black"/><path opacity="0.6" d="M13.1875 7.65789C13.1875 5.91384 14.6053 4.5 16.3542 4.5H21.5V7.65789C21.5 9.40195 20.0822 10.8158 18.3333 10.8158H13.1875V7.65789Z" fill="black"/><path opacity="0.6" d="M13.1875 16.3421C13.1875 14.598 14.6053 13.1842 16.3542 13.1842H21.5V16.3421C21.5 18.0862 20.0822 19.5 18.3333 19.5H13.1875V16.3421Z" fill="black"/></mask><g mask="url(#mGrid)"><rect width="24" height="24" fill="white"/></g></svg>
      </button>
      <button class="h-icon" id="btnSettings">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="mSet" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="2" y="2" width="20" height="20"><path d="M18 11.5H22C22 13.1569 20.6569 14.5 19 14.5H18V11.5Z" fill="url(#pS1)"/><path fill-rule="evenodd" clip-rule="evenodd" d="M12.05 11.5C12.2816 10.3589 13.2905 9.5 14.5 9.5H18V14.5L14 14.5L12 14.5L2 14.5C2 12.8431 3.34315 11.5 5 11.5H12.05Z" fill="black"/><path d="M12 18.5H22C22 20.1569 20.6569 21.5 19 21.5H12V18.5Z" fill="url(#pS2)"/><path fill-rule="evenodd" clip-rule="evenodd" d="M6.05001 18.5C6.28164 17.3589 7.29052 16.5 8.5 16.5H12V21.5L8 21.5L6 21.5L2 21.5C2 19.8431 3.34315 18.5 5 18.5H6.05001Z" fill="black"/><path d="M12 4.5H22C22 6.15685 20.6569 7.5 19 7.5H12V4.5Z" fill="url(#pS3)"/><path fill-rule="evenodd" clip-rule="evenodd" d="M6.05001 4.5C6.28164 3.35888 7.29052 2.5 8.5 2.5H12V7.5H6L2 7.5C2 5.84315 3.34315 4.5 5 4.5H6.05001Z" fill="black"/></mask><g mask="url(#mSet)"><path d="M0 0H24V24H0V0Z" fill="white"/></g><defs><linearGradient id="pS1" x1="22" y1="13" x2="15.8462" y2="13" gradientUnits="userSpaceOnUse"><stop stop-opacity="0.5"/><stop offset="1" stop-opacity="0.3"/></linearGradient><linearGradient id="pS2" x1="22" y1="20" x2="14.3077" y2="20" gradientUnits="userSpaceOnUse"><stop stop-opacity="0.5"/><stop offset="1" stop-opacity="0.3"/></linearGradient><linearGradient id="pS3" x1="22" y1="6" x2="12" y2="6" gradientUnits="userSpaceOnUse"><stop stop-opacity="0.5"/><stop offset="1" stop-opacity="0.3"/></linearGradient></defs></svg>
      </button>
    </div>
  </div>

  <div class="grid-wrapper">
    <div class="grid" id="grid"></div>
  </div>

  <div class="keyboard" id="keyboard"></div>

  <div class="home-indicator">
    <div class="home-bar"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
</div><!-- /device-frame -->

<div class="side-panel open" id="sidePanel">
  <div class="sp-title">Анимация фона</div>

  <div class="s-group">
    <div class="s-label">Количество <input type="number" class="s-val" id="sCountVal" value="80" min="5" max="200" step="1"></div>
    <input type="range" id="sCount" min="5" max="200" value="80">
  </div>
  <div class="s-group">
    <div class="s-label">Скорость <input type="number" class="s-val" id="sSpeedVal" value="1.0" min="0.1" max="3.0" step="0.1"></div>
    <input type="range" id="sSpeed" min="0.1" max="3.0" step="0.1" value="1.0">
  </div>
  <div class="s-group">
    <div class="s-label">Ветер <input type="number" class="s-val" id="sWindVal" value="0.0" min="-2.0" max="2.0" step="0.1"></div>
    <input type="range" id="sWind" min="-2.0" max="2.0" step="0.1" value="0.0">
  </div>
  <div class="s-group">
    <div class="s-label">Размер <input type="number" class="s-val" id="sSizeVal" value="1.1" min="0.3" max="2.5" step="0.1"></div>
    <input type="range" id="sSize" min="0.3" max="2.5" step="0.1" value="1.1">
  </div>
  <div class="s-group">
    <div class="s-label">Кручение <input type="number" class="s-val" id="sSpinVal" value="1.0" min="0.0" max="3.0" step="0.1"></div>
    <input type="range" id="sSpin" min="0.0" max="3.0" step="0.1" value="1.0">
  </div>

  <div class="sp-divider"></div>
  <div class="sp-title">Размер экрана</div>

  <div class="s-group">
    <div class="s-label">Ширина <input type="number" class="s-val" id="fcWVal" value="375" min="320" max="440" step="1"></div>
    <input type="range" id="fcWidth" min="320" max="440" value="375">
  </div>
  <div class="s-group">
    <div class="s-label">Высота <input type="number" class="s-val" id="fcHVal" value="812" min="568" max="956" step="1"></div>
    <input type="range" id="fcHeight" min="568" max="956" value="812">
  </div>
</div>

</div><!-- /stage -->

<script>
(function () {
  'use strict';

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  /* ---------- state ---------- */
  const state = {
    count: 80,
    speed: 1.0,
    wind: 0.0,
    sizeMul: 1.1,
    spinMul: 1.0
  };

  const presets = {
    light:  { count: 40,  speed: 0.8, wind: 0.3,  sizeMul: 1.0, spinMul: 0.8 },
    medium: { count: 90,  speed: 1.2, wind: 0.5,  sizeMul: 1.0, spinMul: 1.2 },
    heavy:  { count: 180, speed: 1.6, wind: 0.8,  sizeMul: 0.9, spinMul: 1.5 }
  };

  /* ---------- palette ---------- */
  const PALETTES = [
    // sakura / cherry blossom
    ['#ffb7c5','#ff91a4','#f7cad0','#ffdde1','#ff6f91'],
    // rose & magenta
    ['#e84393','#fd79a8','#d63384','#f8a5c2','#c44569'],
    // soft lavender
    ['#a29bfe','#b8b5ff','#dcd6f7','#c3aed6','#957fef'],
    // warm white & gold
    ['#ffeaa7','#fdcb6e','#ffffff','#f8e8d4','#fab1a0']
  ];

  /* ---------- shapes: hearts, flowers, petals, stars ---------- */
  function drawShape(ctx, type, s) {
    ctx.beginPath();
    switch (type) {
      case 0: { // heart
        const t = s * 0.9;
        ctx.moveTo(0, t * 0.4);
        ctx.bezierCurveTo(-t, -t * 0.3, -t * 0.5, -t, 0, -t * 0.5);
        ctx.bezierCurveTo(t * 0.5, -t, t, -t * 0.3, 0, t * 0.4);
        break;
      }
      case 1: { // 5-petal flower
        const petals = 5;
        const rOuter = s * 0.85;
        const rInner = s * 0.35;
        for (let i = 0; i < petals; i++) {
          const a1 = (i / petals) * Math.PI * 2 - Math.PI / 2;
          const a2 = ((i + 0.5) / petals) * Math.PI * 2 - Math.PI / 2;
          const px = Math.cos(a1) * rOuter;
          const py = Math.sin(a1) * rOuter;
          const ix = Math.cos(a2) * rInner;
          const iy = Math.sin(a2) * rInner;
          if (i === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
          ctx.quadraticCurveTo(
            Math.cos((a1 + a2) / 2) * rOuter * 0.85,
            Math.sin((a1 + a2) / 2) * rOuter * 0.85,
            ix, iy
          );
        }
        ctx.closePath();
        break;
      }
      case 2: { // cherry blossom (round 5 petals)
        const n = 5;
        const r = s * 0.42;
        for (let i = 0; i < n; i++) {
          const angle = (i / n) * Math.PI * 2 - Math.PI / 2;
          const cx = Math.cos(angle) * s * 0.45;
          const cy = Math.sin(angle) * s * 0.45;
          ctx.moveTo(cx + r, cy);
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
        }
        break;
      }
      case 3: { // teardrop petal
        ctx.moveTo(0, -s);
        ctx.bezierCurveTo(s * 0.6, -s * 0.3, s * 0.5, s * 0.6, 0, s * 0.9);
        ctx.bezierCurveTo(-s * 0.5, s * 0.6, -s * 0.6, -s * 0.3, 0, -s);
        break;
      }
      case 4: { // small star
        const points = 5;
        const outer = s * 0.8;
        const inner = s * 0.35;
        for (let i = 0; i < points * 2; i++) {
          const a = (i / (points * 2)) * Math.PI * 2 - Math.PI / 2;
          const r = i % 2 === 0 ? outer : inner;
          if (i === 0) ctx.moveTo(Math.cos(a) * r, Math.sin(a) * r);
          else ctx.lineTo(Math.cos(a) * r, Math.sin(a) * r);
        }
        ctx.closePath();
        break;
      }
      default: { // simple heart (smaller)
        const h = s * 0.7;
        ctx.moveTo(0, h * 0.4);
        ctx.bezierCurveTo(-h, -h * 0.3, -h * 0.5, -h, 0, -h * 0.5);
        ctx.bezierCurveTo(h * 0.5, -h, h, -h * 0.3, 0, h * 0.4);
        break;
      }
    }
  }

  /* ---------- leaf class ---------- */
  class Leaf {
    constructor(index) {
      this.index = index;
      this.reset(true);
    }

    reset(randomY) {
      const W = canvas.width;
      const H = canvas.height;
      this.x = Math.random() * W * 1.4 - W * 0.2;
      this.y = randomY ? Math.random() * H * 1.2 - H * 0.2 : -Math.random() * H * 0.3 - 30;
      this.size = (10 + Math.random() * 18) * state.sizeMul;
      const types = [0,1,2,3,5];
      this.type = types[Math.floor(Math.random() * types.length)];
      this.palette = PALETTES[Math.floor(Math.random() * PALETTES.length)];
      this.color = this.palette[Math.floor(Math.random() * this.palette.length)];
      this.rotation = Math.random() * Math.PI * 2;
      this.rotSpeed = (Math.random() - 0.5) * 0.04;
      this.vx = (Math.random() - 0.5) * 0.5;
      this.vy = 0.5 + Math.random() * 1.0;
      this.swayAmp = 0.3 + Math.random() * 0.7;
      this.swayFreq = 0.5 + Math.random() * 1.5;
      this.swayOffset = Math.random() * Math.PI * 2;
      this.opacity = 0.6 + Math.random() * 0.4;
      this.flipPhase = Math.random() * Math.PI * 2;
      this.flipSpeed = 0.5 + Math.random() * 1.5;
      this.depth = 0.4 + Math.random() * 0.6; // parallax depth
    }

    update(dt, time) {
      const spd = state.speed * this.depth;
      const sway = Math.sin(time * this.swayFreq + this.swayOffset) * this.swayAmp;

      this.x += (this.vx + state.wind + sway) * spd * dt * 60;
      this.y += this.vy * spd * dt * 60;
      this.rotation += this.rotSpeed * state.spinMul * dt * 60;

      if (this.y > canvas.height + 40 || this.x < -60 || this.x > canvas.width + 60) {
        this.reset(false);
      }
    }

    draw(ctx, time) {
      const flip = Math.cos(time * this.flipSpeed + this.flipPhase);
      const scaleX = 0.3 + 0.7 * Math.abs(flip);
      const sz = this.size * state.sizeMul * this.depth;

      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rotation);
      ctx.scale(scaleX, 1);
      ctx.globalAlpha = this.opacity * this.depth;

      drawShape(ctx, this.type, sz);
      ctx.fillStyle = this.color;
      ctx.fill();

      ctx.shadowColor = this.color;
      ctx.shadowBlur = sz * 0.4;
      ctx.fill();
      ctx.shadowBlur = 0;

      ctx.restore();
    }
  }

  /* ---------- background gradient ---------- */
  function drawBackground() {
    ctx.fillStyle = '#1C1C1E';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }

  /* ---------- leaves pool ---------- */
  let leaves = [];

  function syncLeaves() {
    const target = state.count;
    while (leaves.length < target) leaves.push(new Leaf(leaves.length));
    if (leaves.length > target) leaves.length = target;
  }

  /* ---------- resize ---------- */
  const deviceFrame = document.getElementById('deviceFrame');

  function resize() {
    const fw = deviceFrame ? deviceFrame.clientWidth : window.innerWidth;
    const fh = deviceFrame ? deviceFrame.clientHeight : window.innerHeight;
    canvas.width = fw * devicePixelRatio;
    canvas.height = fh * devicePixelRatio;
    canvas.style.width = fw + 'px';
    canvas.style.height = fh + 'px';
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    canvas.widthCSS = fw;
    canvas.heightCSS = fh;
    updateCellSize();
  }

  function updateCellSize() {
    const wrapper = document.querySelector('.grid-wrapper');
    if (!wrapper) return;
    const w = wrapper.clientWidth - 32;
    const h = wrapper.clientHeight;
    const fromW = (w - 4 * 6) / 5;
    const fromH = (h - 5 * 8) / 6;
    const cell = Math.floor(Math.min(fromW, fromH));
    wrapper.style.setProperty('--cell', cell + 'px');
    updateKbPadding();
  }

  function updateKbPadding() {
    const kb = document.querySelector('.keyboard');
    if (!kb) return;
    const row1 = kb.querySelector('.kb-row');
    if (!row1) return;
    const availW = row1.clientWidth;
    const keyW = (availW - 11 * 3) / 12;
    const midPad = (keyW + 3) / 2;
    kb.style.setProperty('--kb-mid-pad', midPad + 'px');
  }

  /* ---------- FPS ---------- */
  let frameCount = 0, lastFpsTime = performance.now();
  const fpsEl = document.getElementById('fps');

  function updateFps() {
    frameCount++;
    const now = performance.now();
    if (now - lastFpsTime >= 1000) {
      if (fpsEl) fpsEl.textContent = Math.round(frameCount * 1000 / (now - lastFpsTime));
      frameCount = 0;
      lastFpsTime = now;
    }
  }

  /* ---------- main loop ---------- */
  let prevTime = 0;

  function frame(timestamp) {
    requestAnimationFrame(frame);

    const t = timestamp / 1000;
    const dt = prevTime ? Math.min(t - prevTime, 0.1) : 0.016;
    prevTime = t;

    ctx.save();
    // use CSS pixels for drawing, canvas is scaled via transform
    const W = deviceFrame ? deviceFrame.clientWidth : window.innerWidth;
    const H = deviceFrame ? deviceFrame.clientHeight : window.innerHeight;
    canvas.widthCSS = W;
    canvas.heightCSS = H;

    drawBackground();

    syncLeaves();
    for (let i = 0; i < leaves.length; i++) {
      leaves[i].update(dt, t);
      leaves[i].draw(ctx, t);
    }

    ctx.restore();
    updateFps();
  }

  /* ---------- frame controls ---------- */
  const fcWidth = document.getElementById('fcWidth');
  const fcHeight = document.getElementById('fcHeight');
  const fcWVal = document.getElementById('fcWVal');
  const fcHVal = document.getElementById('fcHVal');

  function resizeFrame(w, h) {
    if (deviceFrame) {
      deviceFrame.style.width = w + 'px';
      deviceFrame.style.height = h + 'px';
    }
    resize();
  }

  function syncFrame() {
    resizeFrame(parseInt(fcWidth.value), parseInt(fcHeight.value));
  }

  if (fcWidth) {
    fcWidth.addEventListener('input', () => { fcWVal.value = fcWidth.value; syncFrame(); });
    fcWVal.addEventListener('change', () => {
      let v = Math.min(440, Math.max(320, parseInt(fcWVal.value) || 375));
      fcWVal.value = v; fcWidth.value = v; syncFrame();
    });
  }
  if (fcHeight) {
    fcHeight.addEventListener('input', () => { fcHVal.value = fcHeight.value; syncFrame(); });
    fcHVal.addEventListener('change', () => {
      let v = Math.min(956, Math.max(568, parseInt(fcHVal.value) || 812));
      fcHVal.value = v; fcHeight.value = v; syncFrame();
    });
  }

  /* ---------- init (canvas only, UI resize after DOM built) ---------- */
  syncLeaves();
  window.addEventListener('resize', resize);

  /* ========== GAME: 5 БУКВ ========== */
  const ROWS = 6, COLS = 5;
  const gridEl = document.getElementById('grid');
  const kbEl   = document.getElementById('keyboard');
  const toastEl = document.getElementById('toast');

  const KB_ROWS = [
    'ЙЦУКЕНГШЩЗХЪ',
    'ФЫВАПРОЛДЖЭ',
    '✓ЯЧСМИТЬБЮ⌫'
  ];

  // build grid
  if (gridEl) {
    for (let i = 0; i < ROWS * COLS; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.idx = i;
      cell.innerHTML = '<div class="cell-inner"><div class="cell-front"></div><div class="cell-back"></div></div>';
      gridEl.appendChild(cell);
    }
  }

  // build keyboard
  if (kbEl) {
    KB_ROWS.forEach(row => {
      const rowEl = document.createElement('div');
      rowEl.className = 'kb-row';
      for (const ch of row) {
        const btn = document.createElement('button');
        btn.className = 'key';
        if (ch === '✓' || ch === '⌫') btn.classList.add('wide');
        btn.textContent = ch === '⌫' ? '' : ch;
        if (ch === '⌫') {
          btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg>';
        }
        if (ch === '✓') {
          btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
        }
        btn.dataset.key = ch;
        btn.addEventListener('click', () => onKey(ch));
        rowEl.appendChild(btn);
      }
      kbEl.appendChild(rowEl);
    });
  }

  resize();
  updateKbPadding();
  requestAnimationFrame(frame);

  /* -- game state -- */
  const answer = 'ПЕТЛЯ';
  let curRow = 0, curCol = 0;
  let board = Array.from({length: ROWS}, () => Array(COLS).fill(''));
  let gameOver = false;

  function resetGame() {
    curRow = 0; curCol = 0; gameOver = false;
    board = Array.from({length: ROWS}, () => Array(COLS).fill(''));
    if (gridEl) {
      Array.from(gridEl.children).forEach(c => {
        const inner = c.querySelector('.cell-inner');
        const front = c.querySelector('.cell-front');
        const back = c.querySelector('.cell-back');
        if (inner) inner.classList.remove('flipped');
        if (front) front.textContent = '';
        if (back) { back.textContent = ''; back.className = 'cell-back'; }
        c.classList.remove('filled');
      });
    }
    if (kbEl) {
      kbEl.querySelectorAll('.key').forEach(k => {
        k.classList.remove('correct','present','absent');
        k.style.background = '';
        k.style.color = '';
        k.style.borderColor = '';
      });
    }
    updateActiveRow();
    updateActionKeys();
  }

  function getCell(r, c) {
    return gridEl ? gridEl.children[r * COLS + c] : null;
  }

  function showToast(msg, dur) {
    if (!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), dur || 1500);
  }

  function highlightRow(row) {
    const guess = board[row].join('');
    const ansArr = answer.split('');
    const status = Array(COLS).fill('absent');

    for (let i = 0; i < COLS; i++) {
      if (guess[i] === ansArr[i]) {
        status[i] = 'correct';
        ansArr[i] = null;
      }
    }
    for (let i = 0; i < COLS; i++) {
      if (status[i] !== 'correct') {
        const idx = ansArr.indexOf(guess[i]);
        if (idx !== -1) { status[i] = 'present'; ansArr[idx] = null; }
      }
    }

    const FLIP_STAGGER = 150;

    for (let i = 0; i < COLS; i++) {
      const cell = getCell(row, i);
      if (!cell) continue;
      const back = cell.querySelector('.cell-back');
      const inner = cell.querySelector('.cell-inner');

      if (back) {
        back.textContent = guess[i];
        back.classList.add(status[i]);
      }

      setTimeout(() => {
        if (inner) inner.classList.add('flipped');

        setTimeout(() => {
          const kbKey = kbEl ? kbEl.querySelector(`[data-key="${guess[i]}"]`) : null;
          if (kbKey) {
            const prev = kbKey.classList.contains('correct') ? 2
                       : kbKey.classList.contains('present') ? 1 : 0;
            const next = status[i] === 'correct' ? 2 : status[i] === 'present' ? 1 : 0;
            if (next > prev) {
              kbKey.classList.remove('correct','present','absent');
              kbKey.classList.add(status[i]);
            } else if (prev === 0) {
              kbKey.classList.add(status[i]);
            }
          }
        }, 400);
      }, i * FLIP_STAGGER);
    }

    return guess === answer;
  }

  function updateActiveRow() {
    if (!gridEl) return;
    for (let i = 0; i < ROWS * COLS; i++) {
      gridEl.children[i].classList.remove('active');
    }
    if (!gameOver && curRow < ROWS) {
      for (let c = 0; c < COLS; c++) {
        getCell(curRow, c)?.classList.add('active');
      }
    }
  }

  function updateActionKeys() {
    const delKey = kbEl?.querySelector('[data-key="⌫"]');
    const enterKey = kbEl?.querySelector('[data-key="✓"]');
    if (delKey) {
      if (curCol > 0 && !gameOver) {
        delKey.style.background = '#FFFFFF';
        delKey.style.color = '#333333';
        delKey.style.borderColor = '#FFFFFF';
      } else {
        delKey.style.background = '';
        delKey.style.color = '';
        delKey.style.borderColor = '';
      }
    }
    if (enterKey) {
      if (curCol >= COLS && !gameOver) {
        enterKey.style.background = '#FFDD2D';
        enterKey.style.color = '#333333';
        enterKey.style.borderColor = '#FFDD2D';
      } else {
        enterKey.style.background = '';
        enterKey.style.color = '';
        enterKey.style.borderColor = '';
      }
    }
  }

  function onKey(ch) {
    if (gameOver || curRow >= ROWS) return;

    if (ch === '⌫') {
      if (curCol > 0) {
        curCol--;
        board[curRow][curCol] = '';
        const cell = getCell(curRow, curCol);
        if (cell) {
          const front = cell.querySelector('.cell-front');
          if (front) front.textContent = '';
          cell.classList.remove('filled');
        }
      }
      updateActionKeys();
      return;
    }

    if (ch === '✓') {
      if (curCol < COLS) { showToast('Введите 5 букв'); return; }
      const win = highlightRow(curRow);
      curRow++;
      curCol = 0;
      updateActionKeys();
      const flipDone = (COLS - 1) * 150 + 900;
      if (win) {
        gameOver = true;
        setTimeout(() => { showToast('Отлично!', 2000); setTimeout(resetGame, 2500); }, flipDone);
      } else if (curRow >= ROWS) {
        gameOver = true;
        setTimeout(() => { showToast('Слово: ' + answer, 2000); setTimeout(resetGame, 2500); }, flipDone);
      }
      updateActiveRow();
      return;
    }

    if (curCol < COLS) {
      board[curRow][curCol] = ch;
      const cell = getCell(curRow, curCol);
      if (cell) {
        const front = cell.querySelector('.cell-front');
        if (front) front.textContent = ch;
        cell.classList.add('filled');
      }
      curCol++;
    }
    updateActionKeys();
  }

  // physical keyboard support
  document.addEventListener('keydown', e => {
    if (e.ctrlKey || e.metaKey || e.altKey) return;
    const k = e.key.toUpperCase();
    if (k === 'ENTER') onKey('✓');
    else if (k === 'BACKSPACE') onKey('⌫');
    else if (/^[А-ЯЁ]$/.test(k)) onKey(k);
  });

  updateActiveRow();
  updateKbPadding();

  /* ========== TOGGLE GRID ========== */
  const btnToggleGrid = document.getElementById('btnToggleGrid');
  const gridWrap = document.querySelector('.grid-wrapper');
  const kbWrap = document.querySelector('.keyboard');

  btnToggleGrid?.addEventListener('click', () => {
    const hidden = gridWrap?.style.visibility === 'hidden';
    if (gridWrap) gridWrap.style.visibility = hidden ? '' : 'hidden';
    if (kbWrap) kbWrap.style.visibility = hidden ? '' : 'hidden';
  });

  /* ========== LOGO FLIP ========== */
  setTimeout(() => {
    document.querySelectorAll('#logo .logo-card-inner').forEach((card, i) => {
      setTimeout(() => card.classList.add('flipped'), i * 150);
    });
  }, 3000);

  /* ========== SETTINGS SIDE PANEL ========== */
  const sidePanel = document.getElementById('sidePanel');
  const btnSet    = document.getElementById('btnSettings');

  btnSet?.addEventListener('click', () => {
    sidePanel?.classList.toggle('open');
  });

  function bindSheet(sliderId, valId, prop, fmt) {
    const sl = document.getElementById(sliderId);
    const vl = document.getElementById(valId);
    if (!sl || !vl) return;
    sl.addEventListener('input', () => {
      const v = parseFloat(sl.value);
      state[prop] = v;
      vl.value = fmt ? fmt(v) : v;
    });
    vl.addEventListener('change', () => {
      let v = parseFloat(vl.value);
      if (isNaN(v)) v = parseFloat(sl.value);
      v = Math.min(parseFloat(sl.max), Math.max(parseFloat(sl.min), v));
      state[prop] = v;
      sl.value = v;
      vl.value = fmt ? fmt(v) : v;
    });
  }
  bindSheet('sCount', 'sCountVal', 'count',   v => Math.round(v));
  bindSheet('sSpeed', 'sSpeedVal', 'speed',   v => v.toFixed(1));
  bindSheet('sWind',  'sWindVal',  'wind',    v => v.toFixed(1));
  bindSheet('sSize',  'sSizeVal',  'sizeMul', v => v.toFixed(1));
  bindSheet('sSpin',  'sSpinVal',  'spinMul', v => v.toFixed(1));


})();
</script>
</body>
</html>
